#!/usr/bin/env python
# coding: utf-8

# In[1]:


import requests
from bs4 import BeautifulSoup
import json
from jsonpath import jsonpath
import pandas as pd
res = requests.get('https://ws.api.cnyes.com/charting/api/v1/history?resolution=D&symbol=TWS:0050:STOCK&from=1592697600&to=1584489600&quote=1')
soup = BeautifulSoup(res.text,'html.parser')


# In[2]:


soup


# In[3]:


#將不要的部分折掉
clean_needed = res.text
clean = clean_needed.replace('{"statusCode":200,"message":"OK","data":{"s":"ok","t":[1592524800,1592438400,1592352000,1592265600,1592179200,1591920000,1591833600,1591747200,1591660800,1591574400,1591315200,1591228800,1591142400,1591056000,1590969600,1590710400,1590624000,1590537600,1590451200,1590364800,1590105600,1590019200,1589932800,1589846400,1589760000,1589500800,1589414400,1589328000,1589241600,1589155200,1588896000,1588809600,1588723200,1588636800,1588550400,1588204800,1588118400,1588032000,1587945600,1587686400,1587600000,1587513600,1587427200,1587340800,1587081600,1586995200,1586908800,1586822400,1586736000,1586476800,1586390400,1586304000,1586217600,1586131200,1585699200,1585612800,1585526400,1585267200,1585180800,1585094400,1585008000,1584921600,1584662400,1584576000,1584489600],"o":[89.0,89.05,89.2,88.15,88.1,87.25,90.45,89.65,89.6,88.9,87.7,87.5,86.15,85.0,84.45,83.4,84.9,84.7,84.25,83.15,83.8,84.15,84.0,84.4,83.05,84.05,83.8,83.7,84.6,85.0,84.6,83.5,83.3,83.5,82.4,84.45,83.05,82.9,82.15,80.8,81.15,80.0,82.65,83.25,83.0,80.2,81.25,79.05,79.0,79.0,79.85,78.5,78.5,76.95,76.5,76.8,74.7,78.3,77.4,76.8,73.85,71.0,71.0,71.0,74.95],"h":[89.15,89.3,89.2,89.2,88.3,88.5,90.85,90.7,89.8,89.8,88.35,87.75,86.9,85.5,85.15,84.45,84.9,84.85,84.65,83.5,83.9,84.8,84.2,84.5,83.45,84.25,83.85,84.4,84.6,85.4,84.75,84.15,83.75,83.8,83.3,85.5,83.9,82.9,82.6,81.0,82.0,80.6,82.65,83.5,84.0,81.1,81.5,80.95,79.4,79.35,80.1,79.7,78.9,77.1,76.65,77.2,76.15,78.7,77.45,77.45,75.3,72.1,74.0,71.0,75.25],"l":','').replace(',"c":[88.85,88.9,89.0,88.9,87.0,88.25,89.05,90.45,89.6,89.5,88.35,87.6,86.8,85.3,84.9,84.45,83.85,84.35,84.45,83.5,82.95,84.5,83.8,83.9,83.15,83.85,83.3,84.3,84.05,85.05,84.35,83.85,83.5,83.4,83.0,85.5,83.7,82.55,82.55,80.9,80.9,80.6,80.6,83.0,83.25,80.8,81.2,80.95,78.8,79.3,79.25,79.6,78.5,77.05,75.9,76.15,75.85,76.6,77.2,76.85,74.25,70.8,74.0,68.55,72.8],"v":[2333.985,5035.751,11510.236,10841.047,9573.7,21563.371,14179.192,10998.897,11356.579,15549.542,9916.582,15036.553,18117.244,11947.06,8365.321,5320.69,7476.909,4589.767,15454.949,5250.544,13354.146,7568.047,9894.141,5477.775,8271.703,6190.781,8743.268,4967.165,11549.365,6655.422,6034.013,6140.995,6142.593,7810.636,15648.38,18785.156,11874.079,7556.661,13917.724,5764.752,13298.948,10896.151,21082.454,12336.416,34532.038,12409.525,17361.116,13121.792,7430.914,5824.779,15650.105,15230.698,15302.038,12207.626,9948.017,9764.0,13605.883,21953.901,19215.688,32687.82,26956.843,22465.117,40910.533,68038.34,46790.503],"quote":{"0":"TWS:0050:STOCK","800013":"TWS:0050:STOCK","21":88.9,"800041":0,"isTrading":0,"6":88.85,"56":-0.06,"200009":"元大台灣50","11":-0.05,"12":89.15,"13":88.65,"800001":2333.985},"session":[[1592528400,1592544900]],"nextTime":null}}','')
clean_1 = clean_needed.replace('{"statusCode":200,"message":"OK","data":{"s":"ok","t":','').replace(',"o":[89.0,89.05,89.2,88.15,88.1,87.25,90.45,89.65,89.6,88.9,87.7,87.5,86.15,85.0,84.45,83.4,84.9,84.7,84.25,83.15,83.8,84.15,84.0,84.4,83.05,84.05,83.8,83.7,84.6,85.0,84.6,83.5,83.3,83.5,82.4,84.45,83.05,82.9,82.15,80.8,81.15,80.0,82.65,83.25,83.0,80.2,81.25,79.05,79.0,79.0,79.85,78.5,78.5,76.95,76.5,76.8,74.7,78.3,77.4,76.8,73.85,71.0,71.0,71.0,74.95],"h":[89.15,89.3,89.2,89.2,88.3,88.5,90.85,90.7,89.8,89.8,88.35,87.75,86.9,85.5,85.15,84.45,84.9,84.85,84.65,83.5,83.9,84.8,84.2,84.5,83.45,84.25,83.85,84.4,84.6,85.4,84.75,84.15,83.75,83.8,83.3,85.5,83.9,82.9,82.6,81.0,82.0,80.6,82.65,83.5,84.0,81.1,81.5,80.95,79.4,79.35,80.1,79.7,78.9,77.1,76.65,77.2,76.15,78.7,77.45,77.45,75.3,72.1,74.0,71.0,75.25],"l":[88.65,88.35,88.3,88.15,86.9,87.1,89.0,89.55,88.95,88.8,87.7,87.15,86.1,85.0,84.4,83.0,83.55,84.05,83.85,82.15,82.9,84.1,83.5,83.65,82.8,83.05,83.2,83.6,83.65,84.7,84.0,83.3,82.6,83.0,82.2,84.4,82.95,82.0,81.65,80.45,80.3,79.5,80.5,82.8,82.7,80.05,81.0,79.05,78.55,78.7,78.85,78.35,78.05,75.75,75.85,75.6,74.05,76.45,76.0,76.1,73.7,69.55,70.9,67.25,72.8],"c":[88.85,88.9,89.0,88.9,87.0,88.25,89.05,90.45,89.6,89.5,88.35,87.6,86.8,85.3,84.9,84.45,83.85,84.35,84.45,83.5,82.95,84.5,83.8,83.9,83.15,83.85,83.3,84.3,84.05,85.05,84.35,83.85,83.5,83.4,83.0,85.5,83.7,82.55,82.55,80.9,80.9,80.6,80.6,83.0,83.25,80.8,81.2,80.95,78.8,79.3,79.25,79.6,78.5,77.05,75.9,76.15,75.85,76.6,77.2,76.85,74.25,70.8,74.0,68.55,72.8],"v":[2333.985,5035.751,11510.236,10841.047,9573.7,21563.371,14179.192,10998.897,11356.579,15549.542,9916.582,15036.553,18117.244,11947.06,8365.321,5320.69,7476.909,4589.767,15454.949,5250.544,13354.146,7568.047,9894.141,5477.775,8271.703,6190.781,8743.268,4967.165,11549.365,6655.422,6034.013,6140.995,6142.593,7810.636,15648.38,18785.156,11874.079,7556.661,13917.724,5764.752,13298.948,10896.151,21082.454,12336.416,34532.038,12409.525,17361.116,13121.792,7430.914,5824.779,15650.105,15230.698,15302.038,12207.626,9948.017,9764.0,13605.883,21953.901,19215.688,32687.82,26956.843,22465.117,40910.533,68038.34,46790.503],"quote":{"0":"TWS:0050:STOCK","800013":"TWS:0050:STOCK","21":88.9,"800041":0,"isTrading":0,"6":88.85,"56":-0.06,"200009":"元大台灣50","11":-0.05,"12":89.15,"13":88.65,"800001":2333.985},"session":[[1592528400,1592544900]],"nextTime":null}}','')


# In[4]:


#讀取json格式的資料
Json_data = json.loads(clean)
Json_data_1 = json.loads(clean_1)


# In[5]:


Json_data


# In[8]:


df = pd.DataFrame(Json_data)
df1 = pd.DataFrame(Json_data_1)


# In[11]:


df.columns=['股價']
df1.columns=['日期']


# In[14]:


df1['股價']=df.股價.values


# In[15]:


df1


# In[18]:


df1['日期'] = pd.to_datetime(df1['日期'],unit='s')


# In[19]:


df1.index = df1['日期']


# In[21]:


df1


# In[23]:


get_ipython().run_line_magic('pylab', 'inline')
plt.rcParams['font.sans-serif']=['DFKai-SB']
df1['股價'].plot(kind='line',figsize=[10,5])


# In[28]:


df1['ma3']=df1['股價'].rolling(window = 3).mean()
df2 = df1[df1['日期']>= '2020-04-15']
df2[['股價','ma3']].plot(kind = 'line',figsize=[10,5])


# In[ ]:




